{% extends "impala/base.html" %}

{% block title %}{{ page_title(addon.name) }}{% endblock %}
{% block js %}{% include("amo/recaptcha_js.html") %}{% endblock %}
{% block bodyclass %}gutter{% endblock %}

{% block extrahead %}
  {% if settings.ENGAGE_ROBOTS and addon.status == amo.STATUS_UNREVIEWED %}
    <meta name="robots" content="noindex">
  {% endif %}
  {% for preview in addon.all_previews %}
    <link rel="prefetch" href="{{ preview.image_url }}">
  {% endfor %}
{% endblock %}

{% block content %}
{{ impala_breadcrumbs([(addon.type_url(), amo.ADDON_TYPES[addon.type]),
                (None, addon.name)]) }}

<aside class="secondary addon-vitals">
  {{ addon.average_rating|stars(large=True) }}
  <div><a class="scrollto" href="#reviews">{{ _('{0} user reviews')|f(addon.total_reviews|numberfmt) }}</a></div>
  <div id="daily-users">{{ _('<b>{0}</b> active users')|f(addon.average_daily_users|numberfmt)|safe }}</div>
  <div class="widgets">
    {{ favorites_widget(addon) }}
    {% include 'addons/includes/collection_add_widget.html' %}
    {{ sharing_widget(addon) }}
  </div>
</aside>

{% set version = addon.current_version %}
<section class="primary">
  <div id="addon" class="island c" role="main" data-id="{{ addon.id }}">
    <hgroup>
      <img id="addon-icon" src="{{ addon.get_icon_url(64) }}" class="icon">
      <h2 class="addon"{{ addon.name|locale_html }}>
        {{ addon.name }}
        <span class="version">{{ version.version }}</span>
      </h2>
      <h4 class="author">{{ _('by') }} {{ users_list(addon.listed_authors) }}</h4>
    </hgroup>
    <p id="addon-summary" {{ addon.summary|locale_html }}>{{ addon.summary|nl2br }}</p>
    {{ big_install_button(addon, show_warning=False, impala=True) }}
  </div>

  {% if settings.PERF_THRESHOLD and addon.ts_slowness >= settings.PERF_THRESHOLD %}
    {{ impala_performance_note(amount=addon.ts_slowness) }}
  {% endif %}

  {% if addon.takes_contributions %}
    {{ impala_contribution(addon=addon, src='addon-detail') }}
  {% endif %}

</section>

{% if addon.type != amo.ADDON_PERSONA %}
  {% if addon.all_previews|length > 0 %}
    <section class="previews carousel">
      <a href="#" class="control prev">&laquo;</a>
      <a href="#" class="control next">&raquo;</a>
      <ul id="preview" class="slider">
        {%- for preview in addon.all_previews -%}
          <li class="panel">
            <a class="screenshot thumbnail" rel="jquery-lightbox"
               href="{{ preview.image_url }}" title="{{ preview.caption }}">
              <img src="{{ preview.thumbnail_url }}">
            </a>
          </li>
        {%- endfor -%}
      </ul>
    </section>
  {% endif %}
{% endif %}

<aside class="secondary metadata c">
  <ul class="links">
    <li><a class="home" href="#">Add-on home page</a></li>
    {% if addon.support_url %}
      <li><a class="support" href="{{ addon.support_url|external_url }}">Support site</a></li>
    {% endif %}
    {% if addon.support_email %}
      <li>{{ emaillink(addon.support_email.localized_string,
                       _('Support E-mail')) }}</li>
    {% endif %}
    {% if addon.has_satisfaction %}
      {# get satisfaction only supports en-US so no L10n here #}
      <li><a href="#" id="feedback_btn" class="support-gs"
           data-company="{{ addon.get_satisfaction_company }}"
           data-product="{{ addon.get_satisfaction_product }}">Get Satisfaction</a>
      </li>
    {% endif %}
  </ul>
  <ul>
    <li>{{ _('Version {0}')|f(version.version) }} <a class="scrollto" href="#detail-relnotes">Info</a></li>
    <li>{{ version.created|datetime }}</li>
    <li>Released under <a href="#">GPLV2</a></li>
  </ul>
</aside>

{% if addon.description %}
  <section class="primary island c">
    <h2>{{ _('About this Add-on') }}</h2>
    <p id="addon-description" {{ addon.description|locale_html }}>{{ addon.description|nl2br }}</p>
  </section>
{% endif %}

<aside class="secondary addon-reviews c">
  <div>
    {{ addon.average_rating|stars }}
    {{ _('Average') }}
  </div>
  {% include "reviews/grouped_ratings.html" %}
  <p>
    <a class="button">{{ _('Write a review') }}</a>
  <p>
</aside>

<section id="reviews" class="primary island c">
  <h2>Reviews</h2>
  {% if reviews is defined %}
    {{ impala_review_list_box(addon=addon, reviews=reviews) }}
  {% endif %}
</section>

<aside class="secondary metadata c">
  <h3>{{ _('Related Categories') }}</h3>
  {# categories and other add-ons #}
  {% with categories = addon.categories.filter(application=APP.id) %}
    {% if categories %}
      <ul>
        {# TODO reverse URL #}
        {% for category in categories %}
        <li>
          <a href="{{ category.get_url_path() }}">
            {{ category }}
          </a>
        </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
  {# /categories #}
  {{ tags_box(addon=addon, tags=tags) }}
</aside>

<section class="primary island c">
  {# addon recommendations #}
  {% if recommendations %}
    <section>
      <h2 class="compact-bottom">{{ _('Often used with&hellip;')|safe }}</h2>
      {{ recommendations|addon_grid(cols=3) }}
    </section>
  {% endif %}
  {# /recommendations #}
  {% if collections %}
    <section>
      <h2>{{ _('Part of these Collections') }}</h2>
      {{ collections|collection_grid(cols=3) }}
    </section>
    {% endif %}
  {% if author_addons %}
    <section>
      <h2>
        {% trans count = addon.listed_authors|length,
                 author = users_list(addon.listed_authors) %}
          Other add-ons by {{ author }}
        {% pluralize %}
          Other add-ons by these authors
        {% endtrans %}
      </h2>
      {{ author_addons|addon_grid(cols=3) }}
    </section>
  {% endif %}
</section>

<div class="secondary" role="navigation">

  {% if addon.has_profile() and addon.listed_authors %}
  <div class="highlight">
    {% with single_dev = addon.listed_authors|random %}
      <h3 class="compact-bottom">
        {% trans count=addon.listed_authors|length %}
        Meet the Developer
        {% pluralize %}
        Meet the Developers
        {% endtrans %}
      </h3>
      <img class="avatar" alt="{{ single_dev.name }}" height="64"
           width="64" src="{{ single_dev.picture_url }}"/>
      <p>{{ _("Learn why {0} was created and find out what's next for this "
              'add-on.')|f(addon.name) }}</p>
      <p>
        <a class="more-info" href="{{ addon.meet_the_dev_url() }}">
        {% if addon.listed_authors|length > 1 %}
          {{ _('Meet the Developers') }}
        {% else %}
          {{ _('Meet {0}')|f(single_dev.name) }}
        {% endif %}
        </a>
      </p>
    {% endwith %}
  </div>
  {% endif %}{# /meet the devs #}
</div>{# /secondary #}

{% endblock content %}
